{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="bg-light p-5 rounded-3 shadow-sm">  
                <h1 class="fw-bold mb-3">{{ post.title }}</h1>
                
                <p class="text-muted d-flex justify-content-between">
                    <strong>ì‘ì„±ì:</strong>
                    {% if post.author %}
                        <a href="{% url 'user_profile' post.author.pk %}" class="text-decoration-none fw-bold">
                            {{ post.author.username }}
                        </a>
                    {% else %}
                        <span class="text-muted">ì•Œ ìˆ˜ ì—†ìŒ</span>
                    {% endif %}
                    <small class="text-muted ms-auto">{{ post.created_at|date:"Y-m-d H:i" }}</small>
                </p>
                <hr>
                <p class="fs-5">{{ post.content|linebreaks }}</p>  
                <hr class="my-4">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{% url 'post_list' %}" class="btn btn-outline-secondary">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                    {% if user == post.author %}
                        <div class="d-flex">
                            <a href="{% url 'post_edit' post.pk %}" class="btn btn-primary me-2">ìˆ˜ì •</a>
                            <form action="{% url 'post_delete' post.pk %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">ì‚­ì œ</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
                <hr>
                {% if user.is_authenticated %}
                    <form id="comment-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <textarea id="comment-content" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
                    </form>
                {% else %}
                    <p><a href="{% url 'login' %}">ë¡œê·¸ì¸</a> í›„ì— ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                {% endif %}
                <hr>
                <h3>ëŒ“ê¸€</h3>
                <ul class="list-group" id="comment-list">
                    {% for comment in post.comments.all %}
                        <li class="list-group-item" id="comment-{{ comment.id }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>
                                    <a href="{% url 'user_profile' comment.author.pk %}" class="text-decoration-none fw-bold">
                                        {{ comment.author.username }}
                                    </a>
                                </strong>
                                <small class="text-muted ms-auto">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
                            </div>

                            <!-- ê¸°ì¡´ ëŒ“ê¸€ ë‚´ìš© -->
                            <p id="comment-content-{{ comment.id }}">{{ comment.content }}</p>

                            <!-- âœ… ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ -->
                            {% if comment.author == user %}
                            <div class="d-flex justify-content-end mt-1">
                                <button class="btn btn-sm text-muted edit-btn me-2" data-comment-id="{{ comment.id }}">ìˆ˜ì •</button>
                                <button class="btn btn-sm text-muted delete-btn" data-comment-id="{{ comment.id }}">ì‚­ì œ</button>
                            </div>

                            <!-- âœ… ëŒ“ê¸€ ìˆ˜ì • ì°½ -->
                            <div class="edit-form d-none mt-2 w-100" id="edit-form-{{ comment.id }}">
                                <textarea class="form-control mb-2" id="edit-content-{{ comment.id }}" rows="3">{{ comment.content }}</textarea>
                                <div class="d-flex justify-content-start mt-1">
                                    <button class="btn btn-sm btn-success save-edit-btn" data-comment-id="{{ comment.id }}">ğŸ’¾ ì €ì¥</button>
                                    <button class="btn btn-sm btn-secondary cancel-edit-btn" data-comment-id="{{ comment.id }}">ì·¨ì†Œ</button>
                                </div>
                            </div>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- âœ… ëŒ“ê¸€ AJAX ì²˜ë¦¬ -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        function attachCommentEventListeners() {
            document.querySelectorAll(".delete-btn").forEach(button => {
                button.addEventListener("click", function () {
                    let commentId = this.getAttribute("data-comment-id");
                    let csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
    
                    fetch(`/comment/${commentId}/delete/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById(`comment-${commentId}`).remove();
                        }
                    });
                });
            });
    
            document.querySelectorAll(".edit-btn").forEach(button => {
                button.addEventListener("click", function () {
                    let commentId = this.getAttribute("data-comment-id");
                    document.getElementById(`comment-content-${commentId}`).classList.toggle("d-none");
                    document.getElementById(`edit-form-${commentId}`).classList.toggle("d-none");
                });
            });
    
            document.querySelectorAll(".save-edit-btn").forEach(button => {
                button.addEventListener("click", function () {
                    let commentId = this.getAttribute("data-comment-id");
                    let newContent = document.getElementById(`edit-content-${commentId}`).value;
                    let csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
    
                    fetch(`/comment/${commentId}/edit/`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": csrfToken
                        },
                        body: `content=${encodeURIComponent(newContent)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById(`comment-content-${commentId}`).innerText = data.content;
                            document.getElementById(`comment-content-${commentId}`).classList.remove("d-none");
                            document.getElementById(`edit-form-${commentId}`).classList.add("d-none");
                        }
                    });
                });
            });
    
            document.querySelectorAll(".cancel-edit-btn").forEach(button => {
                button.addEventListener("click", function () {
                    let commentId = this.getAttribute("data-comment-id");
                    document.getElementById(`edit-form-${commentId}`).classList.add("d-none");
                    document.getElementById(`comment-content-${commentId}`).classList.remove("d-none");
                });
            });
        }
    
        // âœ… ëŒ“ê¸€ ì‘ì„± AJAX ì¶”ê°€
        let commentForm = document.getElementById("comment-form");
        if (commentForm) {
            commentForm.addEventListener("submit", function (e) {
                e.preventDefault();
    
                let content = document.getElementById("comment-content").value;
                let csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
    
                fetch("{% url 'add_comment' post.id %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": csrfToken
                    },
                    body: `content=${encodeURIComponent(content)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let commentList = document.getElementById("comment-list");
                        let newComment = document.createElement("li");
                        newComment.classList.add("list-group-item");
                        newComment.setAttribute("id", `comment-${data.comment_id}`);
                        newComment.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>
                                    <a href="/profile/${data.author_id}/" class="text-decoration-none fw-bold">
                                        ${data.author}
                                    </a>
                                </strong>
                                <small class="text-muted ms-auto">${new Date().toLocaleString()}</small>
                            </div>
                            <p id="comment-content-${data.comment_id}">${data.content}</p>
                            <!-- âœ… ìƒˆë¡œ ì¶”ê°€ëœ ëŒ“ê¸€ì—ë„ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í¬í•¨ -->
                            <div class="d-flex justify-content-end mt-1">
                                <button class="btn btn-sm text-muted edit-btn me-2" data-comment-id="${data.comment_id}">ìˆ˜ì •</button>
                                <button class="btn btn-sm text-muted delete-btn" data-comment-id="${data.comment_id}">ì‚­ì œ</button>
                            </div>
                            <!-- âœ… ëŒ“ê¸€ ìˆ˜ì • ì°½ ì¶”ê°€ -->
                            <div class="edit-form d-none mt-2 w-100" id="edit-form-${data.comment_id}">
                                <textarea class="form-control mb-2" id="edit-content-${data.comment_id}" rows="3">${data.content}</textarea>
                                <div class="d-flex justify-content-start mt-1">
                                    <button class="btn btn-sm btn-success save-edit-btn" data-comment-id="${data.comment_id}">ğŸ’¾ ì €ì¥</button>
                                    <button class="btn btn-sm btn-secondary cancel-edit-btn" data-comment-id="${data.comment_id}">ì·¨ì†Œ</button>
                                </div>
                            </div>
                        `;
                        commentList.prepend(newComment);
                        document.getElementById("comment-content").value = ""; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    
                        // âœ… ìƒˆë¡œ ì¶”ê°€ëœ ëŒ“ê¸€ì—ë„ ìˆ˜ì •/ì‚­ì œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì ìš©
                        attachCommentEventListeners();
                    } else {
                        alert("ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        }
    
        attachCommentEventListeners();
    });
    </script>
{% endblock %}
